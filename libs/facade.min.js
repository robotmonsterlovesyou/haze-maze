/*!
 * Facade.js v0.3.0-beta 2014-04-20T23:47:58
 * https://github.com/neogeek/facade.js
 * 
 * Copyright (c) 2014 Scott Doxey
 * Dual-licensed under both MIT and BSD licenses.
 */

!function(){"use strict";function a(a){return"[object Array]"===Object.prototype.toString.call(a)?!0:!1}function b(a){return"[object Function]"===Object.prototype.toString.call(a)?!0:!1}function c(a,b){var c;for(c in b)b.hasOwnProperty(c)&&a.hasOwnProperty(c)&&String(typeof b[c])===String(typeof a[c])&&(a[c]=b[c]);return a}function d(a,b,c){if(!(this instanceof d))return new d(a,b,c);a&&"object"===String(typeof a)&&1===a.nodeType?this.canvas=a:(this.canvas=document.createElement("canvas"),"string"===String(typeof a)&&this.canvas.setAttribute("id",a)),b&&c&&(this.width(b),this.height(c));try{this.context=this.canvas.getContext("2d")}catch(e){throw new Error("Object passed to Facade.js was not a valid canvas element.")}this.dt=null,this.fps=null,this.ftime=null,this._callback=null,this._requestAnimation=null}var e,f,g=document.createElement("canvas").getContext("2d"),h=["fillStyle","font","globalAlpha","globalCompositeOperation","lineCap","lineJoin","lineWidth","miterLimit","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","strokeStyle","textAlign","textBaseline"],i=Math.PI/180;["webkit","moz"].forEach(function(a){e=e||window.requestAnimationFrame||window[a+"RequestAnimationFrame"]||null,f=f||window.cancelAnimationFrame||window[a+"CancelAnimationFrame"]||null}),d.prototype.addToStage=function(a,b){if(!(a instanceof d.Entity))throw new Error("Object passed to Facade.addToStage is not a valid Facade.js entity.");return a.draw(this,b),this},d.prototype.clear=function(){return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this},d.prototype.draw=function(a){if("function"!==String(typeof a))throw new Error("Parameter passed to Facade.draw is not a valid function");return this._callback=a,this.start(),this},d.prototype.exportBase64=function(a,b){return a||(a="image/png"),"number"===String(typeof b)?b/=100:b=1,this.canvas.toDataURL(a,b)},d.prototype.height=function(a){return a&&this.canvas.setAttribute("height",parseInt(a,10)),this.canvas.height},d.prototype.renderWithContext=function(c,d){var e;this.context.save();for(e in c)c.hasOwnProperty(e)&&(a(c[e])&&b(this.context[e])?this.context[e].apply(this.context,c[e]):-1!==h.indexOf(e)&&(this.context[e]=c[e]));d&&d.call(null,this),this.context.restore()},d.prototype.resizeForHDPI=function(){return window.devicePixelRatio>1&&!this.canvas.hasAttribute("data-resized-for-hdpi")&&(this.canvas.setAttribute("style","width: "+this.width()+"px; height: "+this.height()+"px;"),this.canvas.setAttribute("width",this.width()*window.devicePixelRatio),this.canvas.setAttribute("height",this.height()*window.devicePixelRatio),this.context.translate(this.width()/2,this.height()/2),this.context.scale(window.devicePixelRatio,window.devicePixelRatio),this.context.translate(-this.width()/2,-this.height()/2),this.canvas.setAttribute("data-resized-for-hdpi",!0)),this},d.prototype.start=function(){return this._requestAnimation=e(this._animate.bind(this)),this},d.prototype.stop=function(){return this.dt=null,this.fps=null,this.ftime=null,f(this._requestAnimation),this._requestAnimation=null,this},d.prototype.width=function(a){return a&&this.canvas.setAttribute("width",parseInt(a,10)),this.canvas.width},d.prototype._animate=function(a){return"function"===String(typeof this._callback)?(this.ftime&&(this.dt=a-this.ftime,this.fps=(1e3/this.dt).toFixed(2)),this._requestAnimation=e(this._animate.bind(this)),this.ftime=a,this.context.save(),this._callback(),this.context.restore()):this.stop(),this},d.Entity=function(){return void 0},d.Entity.prototype._defaultOptions=function(a){var b,c;b={x:0,y:0,anchor:"top/left",rotate:0,scale:1};for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},d.Entity.prototype._defaultMetrics=function(a){var b,c={x:null,y:null,width:null,height:null};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c},d.Entity.prototype._getAnchorPoint=function(a,b){var c,e=[0,0];return a.anchor.match(/center$/)?e[0]=-b.width/2:a.anchor.match(/right$/)&&(e[0]=-b.width),a.anchor.match(/^center/)?e[1]=-b.height/2:a.anchor.match(/^bottom/)&&(e[1]=-b.height),this instanceof d.Polygon&&(c=this._getStrokeWidthOffset(a),e[0]=e[0]+c,e[1]=e[1]+c),e},d.Entity.prototype._getStrokeWidthOffset=function(a){var b=0;return a.hasOwnProperty("lineWidth")&&(b=a.lineWidth/2),b},d.Entity.prototype._applyTransforms=function(a,b,c){var d=this._getAnchorPoint(b,{x:c.x,y:c.y,width:c.width/b.scale,height:c.height/b.scale});a.translate.apply(a,d),b.rotate&&(a.translate(-d[0],-d[1]),a.rotate(b.rotate*i),a.translate(d[0],d[1])),1!==b.scale&&(a.translate(-d[0],-d[1]),a.scale(b.scale,b.scale),a.translate(d[0],d[1]))},d.Entity.prototype.getOption=function(a){return this._options.hasOwnProperty(a)?this._options[a]:void 0},d.Entity.prototype.getAllOptions=function(){var a,b={};for(a in this._options)this._options.hasOwnProperty(a)&&(b[a]=this._options[a]);return b},d.Entity.prototype._setOption=function(a,b,c){if(this._options.hasOwnProperty(a)){if(String(typeof this._options[a])!==String(typeof b))throw new Error("The value for "+a+" ("+b+") was a "+String(typeof b)+" not a "+String(typeof this._options[a])+".");return c||(this._options[a]=b),b}return void 0},d.Entity.prototype.setOptions=function(a,b){var c,d=this.getAllOptions();if(a){for(c in a)a.hasOwnProperty(c)&&d.hasOwnProperty(c)&&(d[c]=this._setOption(c,a[c],b));b||this._setMetrics()}return d},d.Entity.prototype.getMetric=function(a){return this._metrics.hasOwnProperty(a)?this._metrics[a]:void 0},d.Entity.prototype.getAllMetrics=function(){var a,b={};for(a in this._metrics)this._metrics.hasOwnProperty(a)&&(b[a]=this._metrics[a]);return b},d.Entity.prototype.draw=function(a,d){var e=this.getAllOptions();d&&(e=c(e,d)),b(this._configOptions)&&(e=this._configOptions(e)),b(this._draw)&&a.renderWithContext(e,this._draw.bind(this,a,e))},d.Polygon=function(a){return this instanceof d.Polygon?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Polygon(a)},d.Polygon.prototype=Object.create(d.Entity.prototype),d.Polygon.constructor=d.Entity,d.Polygon.prototype._defaultOptions=function(a){var b,c;b=d.Entity.prototype._defaultOptions({opacity:100,shadowBlur:0,shadowColor:"#000",shadowOffsetX:0,shadowOffsetY:0,points:[],fillStyle:"#000",strokeStyle:"",lineWidth:0,lineCap:"default",lineJoin:"miter",closePath:!0});for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},d.Polygon.prototype._draw=function(a,b){var c,d=a.context,e=b?this._setMetrics(b,!0):this.getAllMetrics();if(this._applyTransforms(d,b,e),b.points.length){d.beginPath();for(c in b.points)b.points.hasOwnProperty(c)&&(6===b.points[c].length?d.bezierCurveTo.apply(d,b.points[c]):5===b.points[c].length?d.arc.apply(d,b.points[c]):d.lineTo.apply(d,b.points[c]));b.closePath?d.closePath():d.moveTo.apply(d,b.points[c]),b.fillStyle&&d.fill(),b.lineWidth>0&&d.stroke()}},d.Polygon.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a},d.Polygon.prototype._setMetrics=function(a){var c,e,f=this._defaultMetrics(),g=this.setOptions(a,!0),h={top:null,right:null,bottom:null,left:null},i=this._getStrokeWidthOffset(g);b(this._configOptions)&&(g=this._configOptions(g));for(c in g.points)g.points.hasOwnProperty(c)&&(2===g.points[c].length?c={x:g.points[c][0],y:g.points[c][1]}:5===g.points[c].length&&(f.width=2*g.points[c][2],f.height=2*g.points[c][2],c={x:g.points[c][0]-g.points[c][2],y:g.points[c][1]-g.points[c][2]}),(c.x<h.left||null===h.left)&&(h.left=c.x),(c.y<h.top||null===h.top)&&(h.top=c.y),(c.x>h.right||null===h.right)&&(h.right=c.x),(c.y>h.bottom||null===h.bottom)&&(h.bottom=c.y));return f.x=g.x+h.left,f.y=g.y+h.top,null===f.width&&null===f.height&&(f.width=h.right-h.left,f.height=h.bottom-h.top),f.width=(f.width+2*i)*g.scale,f.height=(f.height+2*i)*g.scale,e=this._getAnchorPoint(g,f),f.x=f.x+e[0]-i,f.y=f.y+e[1]-i,this instanceof d.Circle&&(f.x=f.x+g.radius,f.y=f.y+g.radius),a||(this._metrics=f),f},d.Circle=function(a){return this instanceof d.Circle?(this._options=this._defaultOptions({radius:0,begin:0,end:360}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Circle(a)},d.Circle.prototype=Object.create(d.Polygon.prototype),d.Circle.constructor=d.Polygon,d.Circle.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.points=[[0,0,a.radius,a.begin*i,a.end*i]],a},d.Circle.prototype._getAnchorPoint=function(a,b){var c=d.Polygon.prototype._getAnchorPoint.call(this,a,b);return c[0]=c[0]+a.radius,c[1]=c[1]+a.radius,c},d.Circle.prototype._setMetrics=function(a){var b=d.Polygon.prototype._setMetrics.call(this,a),c=this.getAllOptions(a);return b.x=b.x-c.radius,b.y=b.y-c.radius,a||(this._metrics=b),b},d.Line=function(a){return this instanceof d.Line?(this._options=this._defaultOptions({x1:0,y1:0,x2:0,y2:0,lineWidth:1}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Line(a)},d.Line.prototype=Object.create(d.Polygon.prototype),d.Line.constructor=d.Polygon,d.Line.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.closePath=!1,a.points=[[a.x1,a.y1],[a.x2,a.y2]],a},d.Line.prototype._getAnchorPoint=function(a,b){var c=[0,0];return a.anchor.match(/center$/)?c[0]=-(b.width/2-a.lineWidth/2):a.anchor.match(/right$/)&&(c[0]=-(b.width-a.lineWidth)),a.anchor.match(/^center/)?c[1]=-(b.height/2-a.lineWidth/2):a.anchor.match(/^bottom/)&&(c[1]=-(b.height-a.lineWidth)),c},d.Rect=function(a){return this instanceof d.Rect?(this._options=this._defaultOptions({width:0,height:0}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Rect(a)},d.Rect.prototype=Object.create(d.Polygon.prototype),d.Rect.constructor=d.Polygon,d.Rect.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.points=[[0,0],[a.width,0],[a.width,a.height],[0,a.height]],a},d.Image=function(a,b){return this instanceof d.Image?(this._options=this._defaultOptions({width:0,height:0,tileX:1,tileY:1,frames:[0],speed:120,loop:!0,callback:function(){return void 0}}),this._metrics=this._defaultMetrics(),this.animating=!1,this.currentFrame=0,this.setOptions(b),void this.load(a)):new d.Image(a,b)},d.Image.prototype=Object.create(d.Entity.prototype),d.Image.constructor=d.Entity,d.Image.prototype.load=function(a){"object"===String(typeof a)&&1===a.nodeType?this.image=a:(this.image=document.createElement("img"),this.image.setAttribute("src",a)),this.image.complete?this._setMetrics():this.image.addEventListener("load",this._setMetrics.bind(this))},d.Image.prototype.play=function(){return this.animating=!0,this},d.Image.prototype.pause=function(){return this.animating=!1,this},d.Image.prototype.reset=function(){return this.currentFrame=0,this},d.Image.prototype.stop=function(){return this.currentFrame=0,this.animating=!1,this},d.Image.prototype._configOptions=function(a){return a.translate=[a.x,a.y],this.image&&this.image.complete&&(a.width||(a.width=this.image.width),a.height||(a.height=this.image.height)),a},d.Image.prototype._setMetrics=function(a){var c,d=this._defaultMetrics(),e=this.setOptions(a,!0);return b(this._configOptions)&&(e=this._configOptions(e)),d.width=e.width*e.tileX*e.scale,d.height=e.height*e.tileY*e.scale,c=this._getAnchorPoint(e,d),d.x=e.x+c[0],d.y=e.y+c[1],a||(this._metrics=d),d},d.Image.prototype._draw=function(a,b){var c,d,e=a.context,f=b?this._setMetrics(b,!0):this.getAllMetrics(),g=0,h=0;if(this.image.complete){for(this._applyTransforms(e,b,f),b.frames.length&&(g=b.frames[this.currentFrame]||0),c=0;c<b.tileX;c+=1)for(d=0;d<b.tileY;d+=1)e.drawImage(this.image,b.width*g,b.height*h,b.width,b.height,b.width*c,b.height*d,b.width,b.height);this.animating&&(this.ftime||(this.ftime=a.ftime,"function"===String(typeof b.callback)&&b.callback.call(this,b.frames[this.currentFrame])),a.ftime-this.ftime>=b.speed&&(this.ftime=a.ftime,this.currentFrame+=1,this.currentFrame>=b.frames.length&&(b.loop?this.currentFrame=0:(this.currentFrame=b.frames.length-1,this.isAnimating=!1)),"function"===String(typeof b.callback)&&b.callback.call(this,b.frames[this.currentFrame])))}},d.Text=function(a,b){return this instanceof d.Text?(this._options=this._defaultOptions({opacity:100,width:0,fontFamily:"Arial",fontStyle:"normal",fontSize:16,lineHeight:1,textAlignment:"left",textBaseline:"top",fillStyle:"#000",strokeStyle:"#000",lineWidth:0}),this._metrics=this._defaultMetrics(),this.lines=[],this.setOptions(b),void this.setText(a)):new d.Text(a,b)},d.Text.prototype=Object.create(d.Entity.prototype),d.Text.constructor=d.Entity,d.Text.prototype.setText=function(a){var c=this.getAllOptions(),d=[],e=null,f="",h=0,i=c.width;for(this.lines=[],a&&(d=a.match(/\n|[\S]+ ?/g)),b(this._configOptions)&&(c=this._configOptions(c)),g.save(),g.font=c.font;d.length;)e=d.shift(),h=g.measureText(f+e.replace(/\s$/,"")).width,c.width>0&&h>c.width||e.match(/\n/)?(this.lines.push([f.replace(/\s$/,""),0,this.lines.length*c.fontSize*c.lineHeight]),f=e.replace(/\n/,"")):(f+=e,h>i&&(i=h));return this.lines.push([f.replace(/\s$/,""),0,this.lines.length*c.fontSize*c.lineHeight]),this.lines.forEach(function(a){h=g.measureText(a[0]).width,"center"===c.textAlignment?a[1]=(i-h)/2:"right"===c.textAlignment&&(a[1]=i-h)}),c.width||this._setOption("width",i),g.restore(),this._setMetrics(),this.lines},d.Text.prototype._draw=function(a,b){var c=a.context,d=b?this._setMetrics(b,!0):this.getAllMetrics();this._applyTransforms(c,b,d),this.lines.forEach(function(a){c.fillText.apply(c,a),b.lineWidth&&c.strokeText.apply(c,a)})},d.Text.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.font=a.fontStyle+" "+parseInt(a.fontSize,10)+"px "+a.fontFamily,a},d.Text.prototype._setMetrics=function(a){var c,d=this._defaultMetrics(),e=this.setOptions(a,!0);return b(this._configOptions)&&(e=this._configOptions(e)),this.lines&&(d.width=e.width*e.scale,d.height=this.lines.length*e.fontSize*e.lineHeight*e.scale),c=this._getAnchorPoint(e,d),d.x=e.x+c[0],d.y=e.y+c[1],a||(this._metrics=d),d},d.Group=function(a){return this instanceof d.Group?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),this.setOptions(a),void(this._objects=[])):new d.Group(a)},d.Group.prototype=Object.create(d.Entity.prototype),d.Group.constructor=d.Entity,d.Group.prototype._draw=function(a,b){var c,d=a.context,e=b?this._setMetrics(b,!0):this.getAllMetrics();this._applyTransforms(d,b,e);for(c in this._objects)this._objects.hasOwnProperty(c)&&a.addToStage(this._objects[c])},d.Group.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a},d.Group.prototype.addToGroup=function(a){a instanceof d.Entity&&-1===this._objects.indexOf(a)&&(this._objects.push(a),this._setMetrics())},d.Group.prototype.removeFromGroup=function(a){a instanceof d.Entity&&-1!==this._objects.indexOf(a)&&(this._objects.splice(this._objects.indexOf(a),1),this._setMetrics())},d.Group.prototype._setMetrics=function(a){var b,c,d,e=this._defaultMetrics(),f=this.setOptions(a,!0),g={top:null,right:null,bottom:null,left:null};for(b in this._objects)this._objects.hasOwnProperty(b)&&(d=this._objects[b].getAllMetrics(),(d.x<g.left||null===g.left)&&(g.left=d.x),(d.y<g.top||null===g.top)&&(g.top=d.y),(d.x+d.width>g.right||null===g.right)&&(g.right=d.x+d.width),(d.y+d.height>g.bottom||null===g.bottom)&&(g.bottom=d.y+d.height));return e.x=f.x+g.left,e.y=f.y+g.top,e.width=(g.right-g.left)*f.scale,e.height=(g.bottom-g.top)*f.scale,c=this._getAnchorPoint(f,e),e.x=f.x+c[0],e.y=f.y+c[1],a||(this._metrics=e),e},"function"===String(typeof window.define)&&window.define.hasOwnProperty("amd")?window.define([],function(){return d}):window.Facade=d}();
//# sourceMappingURL=facade.min.map